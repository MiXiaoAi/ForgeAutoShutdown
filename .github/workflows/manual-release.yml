name: Manual Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.20.1-1.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      draft:
        description: 'Create as draft'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build --no-daemon
      
    - name: Get build info
      id: build_info
      run: |
        VERSION=$(grep "mod_version=" gradle.properties | cut -d'=' -f2)
        JAR_NAME="forgeautoshutdown-$VERSION.jar"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
        echo "jar_path=build/libs/$JAR_NAME" >> $GITHUB_OUTPUT
        
        # Verify JAR exists
        if [ ! -f "build/libs/$JAR_NAME" ]; then
          echo "âŒ Error: JAR file not found at build/libs/$JAR_NAME"
          ls -la build/libs/
          exit 1
        fi
        
        # Get file size
        FILE_SIZE=$(stat -c%s "build/libs/$JAR_NAME")
        echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.tag }}
        name: ForgeAutoShutdown ${{ inputs.tag }}
        draft: ${{ inputs.draft }}
        prerelease: ${{ inputs.prerelease }}
        generate_release_notes: true
        body: |
          ## ğŸ® ForgeAutoShutdown ${{ steps.build_info.outputs.version }}
          
          **Minecraft 1.20.1 Forge Mod for Automatic Server Shutdown**
          
          ### âœ¨ Features
          - â° **Scheduled Shutdown**: Daily time or uptime-based automatic shutdown
          - ğŸ’¤ **Idle Auto-Shutdown**: Configurable time windows for idle detection
          - ğŸ—³ï¸ **Player Voting**: Democratic server shutdown voting system
          - ğŸ” **Server Watchdog**: Monitor server health and performance
          - ğŸ”„ **Hot-Reload**: Update configuration without server restart
          - ğŸ“Š **Status Commands**: Real-time configuration monitoring
          
          ### ğŸ“‹ Requirements
          | Component | Version |
          |-----------|---------|
          | Minecraft | 1.20.1 |
          | Forge | 47.3.0+ |
          | Java | 17+ |
          
          ### ğŸš€ Quick Start
          1. **Download** the JAR file below (`${{ steps.build_info.outputs.jar_name }}`)
          2. **Install** by placing it in your server's `mods` folder
          3. **Start** the server to auto-generate configuration files
          4. **Configure** in `world/serverconfig/forgeautoshutdown-server.toml`
          5. **Reload** with `/forgeautoshutdown reload` (no restart needed!)
          
          ### ğŸ® Commands
          ```
          # Player Commands
          /shutdown              # Start shutdown vote
          /shutdown yes|no       # Cast vote
          
          # Admin Commands (OP level 3)
          /forgeautoshutdown reload    # Hot-reload configuration
          /forgeautoshutdown status    # View current status
          ```
          
          ### âš™ï¸ Configuration Example
          ```toml
          [IdleShutdown]
              Enabled = true
              StartHour = 0          # Monitor from 00:00
              EndHour = 23           # Monitor until 23:59
              IdleTimeout = 30       # Shutdown after 30 min idle
              CheckInterval = 1      # Check every 1 minute
          ```
          
          ### ğŸ“– Documentation
          - **Full Guide**: [README.md](https://github.com/MiXiaoAi/ForgeAutoShutdown/blob/master/README.md)
          - **Configuration**: Detailed setup instructions in README
          - **Commands**: Complete command reference available
          
          ### ğŸ› Support
          - **Issues**: [Report bugs here](https://github.com/MiXiaoAi/ForgeAutoShutdown/issues)
          - **Discussions**: [Community support](https://github.com/MiXiaoAi/ForgeAutoShutdown/discussions)
          
          ---
          
          **File Info**: `${{ steps.build_info.outputs.jar_name }}` ($((${{ steps.build_info.outputs.file_size }} / 1024)) KB)
          
          **Build**: GitHub Actions #${{ github.run_number }} | **Commit**: ${{ github.sha }}
        files: |
          ${{ steps.build_info.outputs.jar_path }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Release Summary
      run: |
        echo "ğŸ‰ Release created successfully!"
        echo "ğŸ“¦ Tag: ${{ inputs.tag }}"
        echo "ğŸ“ File: ${{ steps.build_info.outputs.jar_name }}"
        echo "ğŸ“Š Size: $((${{ steps.build_info.outputs.file_size }} / 1024)) KB"
        echo "ğŸ”— URL: ${{ steps.create_release.outputs.url }}"